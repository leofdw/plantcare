{% extends "base.html" %}

{% block title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å —É—Ö–æ–¥–∞ ‚Äî PlantCare{% endblock %}

{% block body %}
<section class="calendar-section">
    <div class="container">
        <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å —É—Ö–æ–¥–∞ –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏</h2>
        <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–∞—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫ —É—Ö–æ–¥–∞</p>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div class="calendar-controls">
            <button id="prevMonth" class="btn btn-outline">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
            <h3 id="currentMonth">–ê–ø—Ä–µ–ª—å 2025</h3>
            <button id="nextMonth" class="btn btn-outline">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->
        <div id="plantsLoader" style="text-align: center; margin: 1rem 0;">
            –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—à–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è...
        </div>

        <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
        <div class="calendar-grid" id="calendar">
            <!-- –î–Ω–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
        </div>
    </div>
</section>



<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–∞—Å—Ç–µ–Ω–∏—è –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ -->
<div id="addModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>–î–æ–±–∞–≤–∏—Ç—å —É—Ö–æ–¥ –∑–∞ —Ä–∞—Å—Ç–µ–Ω–∏–µ–º</h3>
        
        <label>–†–∞—Å—Ç–µ–Ω–∏–µ:</label>
        <select id="plantSelect" class="form-select">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ</option>
        </select>

        <label>–¢–∏–ø —É—Ö–æ–¥–∞:</label>
        <select id="eventType" class="form-select">
            <option value="watering">–ü–æ–ª–∏–≤</option>
            <option value="fertilization">–£–¥–æ–±—Ä–µ–Ω–∏–µ</option>
        </select>

        <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª (–¥–Ω–µ–π):</label>
        <input type="number" id="repeatDays" class="form-input" min="1" max="90" value="7">

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
        <div id="errorMessage" class="error-message" style="display: none;">
            ‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è: –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ –∏ —É–∫–∞–∂–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª
        </div>

        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="saveEvent()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>



<style>
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 0.75rem;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        font-size: 0.9rem;
        margin: 0.5rem 0 1rem;
        text-align: center;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–ª—è –ø—Ä–∏ –æ—à–∏–±–∫–µ */
    .form-select.error,
    .form-input.error {
        border-color: #dc3545 !important;
        background-color: #fff5f5;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
    }

    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #ddd;
        border-radius: 12px;
        overflow: hidden;
    }

    .calendar-header {
        background: var(--primary);
        color: white;
        text-align: center;
        padding: 1rem;
        font-weight: 600;
    }

    .calendar-day {
        background: white;
        min-height: 100px;
        padding: 0.5rem;
        border: 1px solid #eee;
        position: relative;
        cursor: pointer;
        transition: all 0.2s;
    }

    .calendar-day:hover {
        background: #f0f8f0;
        transform: scale(1.02);
        z-index: 1;
    }

    .calendar-day.other-month {
        background: #f8f9fa;
        color: #999;
    }

    .day-number {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
        text-align: right;
    }

    .watering-entry {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        margin: 0.1rem 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: white;
        font-weight: 500;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }

    .modal.active {
        display: flex;
    }

    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
    }

    .form-select, .form-input {
        width: 100%;
        padding: 0.75rem;
        margin: 0.5rem 0 1.5rem;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
    }

    .modal-footer {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 1rem;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    .btn-outline {
        background: #f8f9fa;
        color: #495057;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }
</style>

<script>
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDate = null;
    let favoritePlants = [];

    const wateringColor = '#2196f3';
    const fertilizationColor = '#4caf50'; // —è—Ä–∫–æ-–∑–µ–ª—ë–Ω—ã–π

    // === –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—Ç–µ–Ω–∏–π ===
    async function loadFavoritePlants() {
        try {
            const response = await fetch('/api/favorite-plants');
            if (!response.ok) throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É');

            favoritePlants = await response.json();

            const select = document.getElementById('plantSelect');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—Ç–µ–Ω–∏–µ</option>';

            favoritePlants.forEach(plant => {
                const option = document.createElement('option');
                option.value = plant.id;
                option.textContent = plant.name;
                select.appendChild(option);
            });

            document.getElementById('plantsLoader').style.display = 'none';

        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å—Ç–µ–Ω–∏–π:', e);
            document.getElementById('plantsLoader').innerHTML = '<p style="color: red;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å—Ç–µ–Ω–∏—è</p>';
        }
    }
    async function loadFertilizationEvents() {
        try {
            const response = await fetch(`/api/fertilization-schedule?year=${currentYear}&month=${currentMonth + 1}`);
            const events = await response.json();
            events.forEach(event => {
                const day = document.querySelector(`.calendar-day[data-date="${event.date}"]`);
                if (day) {
                    const entry = document.createElement('div');
                    entry.className = 'watering-entry';
                    entry.style.backgroundColor = fertilizationColor;  // üå± –í–°–ï–ì–î–ê –∑–µ–ª—ë–Ω—ã–π
                    entry.textContent = `üå± ${event.plant_name}`;
                    entry.title = `–£–¥–æ–±—Ä–µ–Ω–∏–µ (–∫–∞–∂–¥—ã–µ ${event.repeat_interval} –¥–Ω.)`;
                    day.appendChild(entry);
                }
            });
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–¥–æ–±—Ä–µ–Ω–∏–π:', e);
        }
    }


    // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è ===
    function generateCalendar() {
        const calendar = document.getElementById('calendar');
        const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];

        document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;

        calendar.innerHTML = '';
        const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        days.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.textContent = day;
            calendar.appendChild(header);
        });

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - (firstDay.getDay() + 6) % 7); // –ü–Ω

        const endDate = new Date(lastDay);
        endDate.setDate(endDate.getDate() + (7 - lastDay.getDay()) % 7);

        loadEvents(); // –ø–æ–ª–∏–≤
        loadFertilizationEvents(); // —É–¥–æ–±—Ä–µ–Ω–∏–µ


        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const day = document.createElement('div');
            day.className = 'calendar-day';
            if (currentDate.getMonth() !== currentMonth) {
                day.classList.add('other-month');
            }

            const dayNum = document.createElement('div');
            dayNum.className = 'day-number';
            dayNum.textContent = currentDate.getDate();
            day.appendChild(dayNum);

            const dateStr = currentDate.toISOString().split('T')[0];
            day.dataset.date = dateStr;

            day.addEventListener('click', () => {
                selectedDate = dateStr;
                document.getElementById('addModal').style.display = 'flex';
            });

            calendar.appendChild(day);
            currentDate.setDate(currentDate.getDate() + 1);
        }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π ===
    async function loadEvents() {
        try {
            const response = await fetch(`/api/watering-schedule?year=${currentYear}&month=${currentMonth + 1}`);
            const events = await response.json();
            events.forEach(event => {
                const day = document.querySelector(`.calendar-day[data-date="${event.date}"]`);
                if (day) {
                    const entry = document.createElement('div');
                    entry.className = 'watering-entry';
                    entry.style.backgroundColor = wateringColor;  // üîµ –í–°–ï–ì–î–ê –≥–æ–ª—É–±–æ–π
                    entry.textContent = `üíß ${event.plant_name}`;
                    entry.title = `–ü–æ–ª–∏–≤ (–∫–∞–∂–¥—ã–µ ${event.repeat_interval} –¥–Ω.)`;
                    day.appendChild(entry);
                }
            });
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–∏–≤–∞:', e);
        }
    }


    // === –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ===
    async function saveEvent() {
        const plantId = document.getElementById('plantSelect').value;
        const repeatDays = parseInt(document.getElementById('repeatDays').value);
        const eventType = document.getElementById('eventType').value; // 'watering' –∏–ª–∏ 'fertilization'

        document.getElementById('errorMessage').style.display = 'none';

        if (!plantId || !selectedDate || isNaN(repeatDays) || repeatDays < 1) {
            document.getElementById('errorMessage').style.display = 'block';
            return;
        }

        const url = eventType === 'fertilization' 
            ? '/api/save-fertilization' 
            : '/api/save-watering';

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                date: selectedDate,
                plant_id: plantId,
                repeat_days: repeatDays
            })
        });

        const result = await response.json();

        if (result.success) {
            closeModal();
            generateCalendar(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
        }
    }

    // === –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ===
    function closeModal() {
        document.getElementById('addModal').style.display = 'none';
        selectedDate = null;
        document.getElementById('plantSelect').value = '';
        document.getElementById('repeatDays').value = '7';
    }

    // === –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º ===
    document.getElementById('prevMonth').addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        generateCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        generateCalendar();
    });

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    document.addEventListener('DOMContentLoaded', () => {
        loadFavoritePlants();
        generateCalendar();
    });

</script>
{% endblock %}
